---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
```{r}
library(dplyr)
library(ggplot2)
library(tableone)  # for pretty summary tables
library(lme4)
library(lattice)
library(performance)
library(geepack)
library(tidyr)
library(mice)
library(mgcv)
  library(lmerTest) 
# Read the data
df_complete <- read.csv("./DataSet2025.csv")
df <- df_complete %>% filter(!is.na(Female)) #drop participants that did not mark male/female, made up 6/300 participants
df_mar <- df
df_mar$stepcount[df_mar$stepcount == 0] <- NA
```

```{r}
df_lmm <- df_mar %>%
  mutate(
    day = as.numeric(day),  # ensure day is numeric
    day1 = day,             # slope before and through Day 7
    day2 = pmax(0, day - 7) # slope *after* Day 7 (starts at 0, increases only after day 7)
  )
```


```{r}
m_full <- lmer(stepcount ~ Group * (day1 + day2) * Act + Female + Age + 
                 (1 + day1 + day2 || id),
               data = df_lmm, REML = FALSE)
m_intercept <- lmer(stepcount ~ Group * (day1 + day2) * Act + Female + Age + 
                      (1 | id),
                    data = df_lmm, REML = FALSE)

m_day1 <- lmer(stepcount ~ Group * (day1 + day2) * Act + Female + Age + 
                 (1 + day1 || id),
               data = df_lmm, REML = FALSE)


anova(m_intercept, m_full)

```
```{r}
summary(m_full)
```

```{r}
anova(m_day1, m_full)
```
```{r}
model_control  <- lmer(stepcount ~ (day1 + day2) * Act + Female + Age + (1 + day1 + day2 || id),
                       data = subset(df_lmm, Group == "Control"))

model_standard <- lmer(stepcount ~ (day1 + day2) * Act + Female + Age + (1 + day1 + day2 || id),
                       data = subset(df_lmm, Group == "Standard"))

model_tailored <- lmer(stepcount ~ (day1 + day2) * Act + Female + Age + (1 + day1 + day2 || id),
                       data = subset(df_lmm, Group == "Tailored"))
```

```{r}
summary(model_control)
```
```{r}
summary(model_standard)
```

```{r}
summary(model_tailored)
```
```{r}
mod_het <- lme(
  stepcount ~ day1 + day2 + Group * Act + Female + Age,
  random = ~ 1 | Group/id,
  data = df_lmm
)

mod_hom <- lme(
  stepcount ~ day1 + day2 + Group * Act + Female + Age,
  random = ~ 1 | id,
  data = df_lmm
)

anova(mod_hom, mod_het)
```


```{r}
confint(model_control, method = "profile")
confint(model_standard, method = "profile")
confint(model_tailored, method = "profile")
confint(m_full, method = "profile")
```

```{r}
VarCorr(model_control)
VarCorr(model_standard)
VarCorr(model_tailored)
```

```{r}
plot(m_full, which = 1)

# Q-Q plot
qqnorm(residuals(m_full))
qqline(residuals(m_full),col=2)
```

